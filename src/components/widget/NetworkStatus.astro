---
import WidgetLayout from "./WidgetLayout.astro";

// âš™ï¸ åœ¨æ­¤å¤„é…ç½®ä½ çš„çº¿è·¯
const servers = [
	{
		name: "æºç«™ç‚¹",
		url: "https://072145.xyz",
		id: "PS",
	},
	{
		name: "Cloudflare",
		url: "https://cloud.072145.xyz",
		id: "cf",
	},
	{
		name: "Vercel",
		url: "https://my-website-murex-iota.vercel.app/",
		id: "origin",
	},
	{
		name: "dev",
		url: "http://localhost:4321",
		id: "local",
	},
];
---

<WidgetLayout name="çº¿è·¯åˆ‡æ¢" id="network-status" isCollapsed={false}>
    <div class="flex flex-col gap-2">
        {servers.map((server) => (
            <a href={server.url} 
               target="_blank"
               class="server-item flex items-center justify-between p-2 rounded-lg bg-[var(--card-bg)] hover:bg-[var(--btn-plain-bg-hover)] transition-colors text-sm group"
               data-url={server.url}
            >
                <div class="flex items-center gap-2">
                    {/* çŠ¶æ€ç‚¹ */}
                    <span class="w-2 h-2 rounded-full bg-gray-300 status-dot"></span>
                    <span class="text-75 font-medium group-hover:text-[var(--primary)] transition-colors">{server.name}</span>
                </div>
                {/* å»¶è¿Ÿæ•°å€¼ */}
                <span class="latency-text text-xs text-50 font-mono">waiting...</span>
            </a>
        ))}
    </div>
</WidgetLayout>

<script>
    function checkLatency() {
        const items = document.querySelectorAll('.server-item');
        const currentOrigin = window.location.origin;

        items.forEach(async (item) => {
            const url = item.getAttribute('data-url');
            if (!url) return;

            // ğŸ”§ ä¿®å¤æ ¸å¿ƒï¼šåŠ äº† 'as HTMLElement' æ¥è§£å†³æŠ¥é”™
            const dot = item.querySelector('.status-dot') as HTMLElement;
            const text = item.querySelector('.latency-text') as HTMLElement;
            
            // å®‰å…¨æ£€æŸ¥ï¼šå¦‚æœæ‰¾ä¸åˆ°å…ƒç´ å°±è·³è¿‡ï¼Œè§£å†³ 'å¯èƒ½ä¸º null' çš„æŠ¥é”™
            if (!dot || !text) return;

            // ğŸ’¡é«˜äº®å½“å‰æ­£åœ¨ä½¿ç”¨çš„çº¿è·¯
            if (new URL(url).origin === currentOrigin) {
                item.classList.remove('bg-[var(--card-bg)]');
                item.classList.add('bg-[var(--primary)]', 'text-white');
                text.style.color = 'white';
                text.classList.add('!text-white');
            }

            // å¼€å§‹æµ‹é€Ÿ
            const start = Date.now();
            try {
                await fetch(url, { mode: 'no-cors', cache: 'no-store' });
                const end = Date.now();
                const latency = end - start;

                text.textContent = latency + 'ms';
                
                // é¢œè‰²é€»è¾‘
                if (new URL(url).origin !== currentOrigin) {
                    if (latency < 100) {
                        dot.style.backgroundColor = '#10b981'; // ğŸŸ¢
                        text.style.color = '#10b981';
                    } else if (latency < 300) {
                        dot.style.backgroundColor = '#f59e0b'; // ğŸŸ¡
                        text.style.color = '#f59e0b';
                    } else {
                        dot.style.backgroundColor = '#ef4444'; // ğŸ”´
                        text.style.color = '#ef4444';
                    }
                } else {
                    // å½“å‰çº¿è·¯ä¸‹çš„ç‚¹é¢œè‰²
                    if (latency < 100) dot.style.backgroundColor = '#fff';
                    else if (latency < 300) dot.style.backgroundColor = '#fef08a';
                    else dot.style.backgroundColor = '#fca5a5';
                }

            } catch (e) {
                text.textContent = 'è¶…æ—¶';
                dot.style.backgroundColor = '#9ca3af';
            }
        });
    }

    document.addEventListener('astro:page-load', checkLatency);
    document.addEventListener('DOMContentLoaded', checkLatency);
</script>